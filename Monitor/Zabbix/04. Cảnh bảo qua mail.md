# Thiết lập cảnh báo qua email
## 1. Cấu hình alert scritps email
### Cài đặt môi trường 
- Do scripts gửi cảnh báo thông qua email được viết bằng ngôn ngữ python nên phải cài môi trường python để chạy được scripts:
```sh
sudo apt install python3
sudo apt install python3-pip
```

- Kiểm tra:
![image](https://github.com/user-attachments/assets/e3103c67-3938-4f54-b14b-e358ff3e193b)

### Download scripts alert email
- Kiểm tra thư mục để các scripts alert cho zabbix server
```sh
cat /etc/zabbix/zabbix_server.conf | grep alert
```

- Kết quả các file scripts được đặt ở thư mục có đường dẫn `/usr/lib/zabbix/alertscripts`
![image](https://github.com/user-attachments/assets/a57349f5-bfff-49a4-8490-56558219117d)

- Vào thư mục để chứa scripts và download scripts về:
```sh
cd /usr/lib/zabbix/alertscripts
wget https://raw.githubusercontent.com/domanhduy/zabbix-monitor/master/Alert/Email/zabbix-alert-smtp.sh
chmod +x zabbix-alert-smtp.sh
```

![image](https://github.com/user-attachments/assets/786d70ff-03ac-4dc1-9f73-647e28284971)

### Chỉnh sửa file scripts
- Để người quản trị có thể nhận được các cảnh báo thông qua email, phải thiết lập địa chỉ email gửi đi các cảnh báo trong scripts
```sh
sudo nano zabbix-alert-smtp.sh
```

- Chỉnh sửa 2 tham số sau
```sh
# Mail Account
MAIL_ACCOUNT = 'emailcuaban@gmail.com'
MAIL_PASSWORD = 'password email cua ban'
```
![image](https://github.com/user-attachments/assets/40af6998-c4c1-400c-94ce-39266f5ce863)

- LƯU Ý:
  - File scripts này là mã của python2, mà bên trên cài python3 nên sẽ cần sửa đổi một số cú pháp để phù hợp với python3 thì file scripts này mới có thể hoạt động
  - Thay vì sử dụng `email.MIMEText`, sử dụng `email.mime.text`.
![image](https://github.com/user-attachments/assets/976236b3-a94a-4c21-9990-78893f9b73ec)

- Đồng thời cũng phải sửa đổi cú pháp print u"""...""" không hợp lệ trong Python 3.x, print u"""...""" không hợp lệ trong Python 3.x.
![image](https://github.com/user-attachments/assets/d94e82fe-de40-4987-a0df-a6c3f7d0f355)

### Gửi test cảnh báo

Đứng tại thư mục chứa scripts `/usr/lib/zabbix/alertscripts` chạy lệnh test dưới

```sh
./zabbix-alert-smtp.sh dia_chi_email_nhan_canh_bao@gmail.com "Test" "Alert Zabbix"
```

Check email

![](./images/Screenshot_201.png)


LƯU Ý: Nếu khi gửi ta có cảnh báo như sau thì ta phải thiết lập mật khẩu ứng dụng cho tài khoản google ta mới có thể dùng được tài khoản email này để thông báo cảnh báo. Sau khi thiết lập mật khẩu ứng dụng xong, lấy mật khẩu đó và điền vào file scripts là thành công


```sh
ngocnd@anonymous:/usr/lib/zabbix/alertscripts$ ./zabbix-alert-smtp.sh dia_chi_email_nhan_canh_bao@gmail.com "Test" "Alert Zabbix"
Traceback (most recent call last):
  File "./zabbix-alert-smtp.sh", line 55, in <module>
    send_mail(
  File "./zabbix-alert-smtp.sh", line 42, in send_mail
    raise e
  File "./zabbix-alert-smtp.sh", line 39, in send_mail
    session.login(MAIL_ACCOUNT, MAIL_PASSWORD)
  File "/usr/lib/python3.8/smtplib.py", line 743, in login
    raise last_exception
  File "/usr/lib/python3.8/smtplib.py", line 732, in login
    (code, resp) = self.auth(
  File "/usr/lib/python3.8/smtplib.py", line 655, in auth
    raise SMTPAuthenticationError(code, resp)
smtplib.SMTPAuthenticationError: (534, b'5.7.9 Application-specific password required. For more information, go to\n5.7.9  https://support.google.com/mail/?p=InvalidSecondFactor g30-20020a63565e000000b005f05c88c149sm3339799pgm.71 - gsmtp')
```

## Cấu hình cảnh bảo email trên Web Zabbix 

### Truy cập zabbix server


![](./images/Screenshot_205.png)


### Tạo Media Type

Media type chính là các kênh kể zabbix server gửi cảnh báo có thể là Email, SMS hay một kênh được tạo ra bằng scripts.

Click `Administrator >> Media types >> Create a type`


![](./images/Screenshot_206.png)


Nhập các thông tin về media type mới


```sh
Name: Gmail (Tên có thể tùy đặt)
Type: Script
Script name: Tên của script có trong thư mục alert script của server zabbix
Script parameter:
{ALERT.SENDTO}
{ALERT.SUBJECT}
{ALERT.MESSAGE}
```

![](./images/Screenshot_207.png)


Tạo thành công `Meida type` mới có tên là `Gmail`


![](./images/Screenshot_208.png)


### Thiết lập user nhận alert qua email

Chọn **Administrator >> uesr >> Lựa chọn user nhận email cảnh báo**

![](./images/Screenshot_210.png)


Click **Media >> Add**


![](./images/Screenshot_211.png)


Nhập email cảnh báo

```sh
Type: Chính là type mà đã tạo ở trên
Sento: Địa chỉ emal sẽ nhận được alert
Use of serverity: Các mức cảnh bảo
Enable: Tích chọn
```

![](./images/Screenshot_212.png)


Sau khi thiết lập xong chọn update

![](./images/Screenshot_213.png)


### Tạo action

Tạo `action` để khi có sự bất thường đối với các thông số monitor sẽ có alert qua email

Click **Configuration >> Action >> Trigger action >> Create action**


![](./images/Screenshot_214.png)


Đặt tên cho `Action`

![](./images/Screenshot_215.png)



Cấu hình `Actions` trong phần `operations`


![](./images/Screenshot_216.png)


Đầu tiên, cấu hình phần `Operations` chọn `Add`


![](./images/Screenshot_217.png)


```sh
Subject: Problem: {EVENT.NAME}
Message: 
Problem started at {EVENT.TIME} on {EVENT.DATE}
{TRIGGER.NAME} on {HOSTNAME}
Status: {TRIGGER.STATUS}
Severity: {TRIGGER.SEVERITY}
Values: {ITEM.VALUE1}

Item Graphic: [{ITEM.ID1}]
```


Tiếp theo cấu hình phần `Recovery Operation` 


![](./images/Screenshot_218.png)


![](./images/Screenshot_219.png)



```sh
Subject: Resolved: {EVENT.NAME}
Message:
Problem has been resolved at {EVENT.RECOVERY.TIME} on {EVENT.RECOVERY.DATE}
{TRIGGER.NAME} on {HOSTNAME}
Status: {TRIGGER.STATUS}
Severity: {TRIGGER.SEVERITY}
Values: {ITEM.VALUE1}

Item Graphic: [{ITEM.ID1}]
```

Cuối cùng nhấn **Add** để thêm vào là thành công


![](./images/Screenshot_222.png)



### Test cảnh báo gửi qua Mail

Tắt một thiết bị đang giám sát đi và email cảnh báo sẽ được gửi về

![](./images/Screenshot_221.png)


![](./images/Screenshot_220.png)



Như vậy là đã thành công. Good lucky!
